# Latency æµ‹é‡åˆ†ææ–‡æ¡£ç´¢å¼•

## ğŸ“š æ–‡æ¡£æ¦‚è§ˆ

æœ¬ç›®å½•åŒ…å«å…³äº latency æµ‹é‡é—®é¢˜åˆ†æã€è§£å†³æ–¹æ¡ˆå’Œé‡æ„çš„è¯¦ç»†æ–‡æ¡£ã€‚

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### é—®é¢˜åˆ†æ
- **[å…³é”®æ´å¯Ÿæ€»ç»“](key_insights_latency_measurement.md)** â­ **æ¨èå…ˆè¯»**
  - 5 ä¸ªå…³é”®æ´å¯Ÿ
  - é—®é¢˜æ ¹æºå’Œè§£å†³æ–¹æ¡ˆ
  - æœ€ä½³å®è·µ

- **[é—®é¢˜æ€»ç»“](latency_measurement_issue_summary.md)**
  - é—®é¢˜ç°è±¡å’Œæ•°æ®éªŒè¯
  - å…³é”®ä»£ç ä½ç½®
  - é—®é¢˜æ ¹æºåˆ†æ

- **[ä»£ç ä½ç½®è¯¦è§£](latency_measurement_code_locations.md)**
  - è¯¦ç»†çš„ä»£ç ä½ç½®è¯´æ˜
  - æ¯ä¸ªæµ‹é‡é˜¶æ®µçš„å®ç°
  - é—®é¢˜åˆ†æ

### è§£å†³æ–¹æ¡ˆ
- **[å®Œæ•´é‡æ„æ–‡æ¡£](latency_measurement_refactoring.md)** â­ **æœ€è¯¦ç»†**
  - å®Œæ•´çš„é—®é¢˜åˆ†æ
  - è§£å†³æ–¹æ¡ˆè®¾è®¡
  - å®ç°ç»†èŠ‚
  - ä»£ç å˜æ›´æ€»ç»“

- **[Decode æµ‹é‡ç­–ç•¥](decode_measurement_strategy.md)**
  - Decode æµ‹é‡æ–¹æ¡ˆå¯¹æ¯”
  - Overhead åˆ†æ
  - å·¥ç¨‹å®è·µå»ºè®®

### å…¶ä»–åˆ†æ
- **[Tier Fallback åˆ†æ](tier_fallback_analysis.md)**
  - Tier fallback æœºåˆ¶åˆ†æ
  - ç§»é™¤ fallback çš„ rationale

---

## ğŸ” å…³é”®é—®é¢˜

### é—®é¢˜ç°è±¡
- 22.85% çš„æ ·æœ¬ `T_LLM_decode = 0.0` ä½† `output_tokens > 0`
- å¹³å‡æµ‹é‡è¯¯å·®è¾¾åˆ° **21.73 ms**

### æ ¹æœ¬åŸå› 
1. **Vision è¢«è®¡ç®—äº† 3 æ¬¡**ï¼Œæ¯æ¬¡æ—¶é—´ä¸åŒ
2. **æµ‹é‡ç¯å¢ƒä¸ä¸€è‡´**ï¼ˆGPU ç¼“å­˜çŠ¶æ€ä¸åŒï¼‰
3. **å‡æ³•è®¡ç®—ç´¯ç§¯è¯¯å·®**

### è§£å†³æ–¹æ¡ˆ
1. **åœ¨åŒä¸€ä¸ªæµç¨‹ä¸­æµ‹é‡æ‰€æœ‰ç»„ä»¶**ï¼ˆä½¿ç”¨ hooksï¼‰
2. **Vision backbone ä½œä¸ºæ•´ä½“**ï¼ˆåªæµ‹é‡ `T_vision_total`ï¼‰
3. **åªæµ‹é‡æ€»çš„ decode æ—¶é—´**ï¼ˆä¸æ˜¯æ¯ä¸ª tokenï¼‰

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

1. **æµ‹é‡ç¯å¢ƒä¸€è‡´æ€§è‡³å…³é‡è¦** - ä¸åŒçš„æµ‹é‡ç¯å¢ƒä¼šå¯¼è‡´å‡ åæ¯«ç§’çš„è¯¯å·®
2. **å‡æ³•è®¡ç®—ä¼šæ”¾å¤§è¯¯å·®** - åˆ†åˆ«æµ‹é‡ç„¶åå‡æ³•è®¡ç®—ä¼šç´¯ç§¯è¯¯å·®
3. **Vision Backbone åº”è¯¥ä½œä¸ºæ•´ä½“** - é¿å…ä¸å¿…è¦çš„ç»„ä»¶æ‹†åˆ†
4. **æµ‹é‡ Overhead éœ€è¦æœ€å°åŒ–** - å‡å°‘æµ‹é‡è°ƒç”¨å¯ä»¥æé«˜å‡†ç¡®æ€§
5. **`torch.cuda.empty_cache()` çš„å½±å“** - æ¸…ç©ºç¼“å­˜ä¼šå¯¼è‡´æµ‹é‡ç¯å¢ƒä¸ä¸€è‡´

è¯¦ç»†å†…å®¹è¯·å‚è€ƒ [å…³é”®æ´å¯Ÿæ€»ç»“](key_insights_latency_measurement.md)ã€‚

---

## ğŸ“– é˜…è¯»å»ºè®®

### å¿«é€Ÿäº†è§£
1. å…ˆè¯» [å…³é”®æ´å¯Ÿæ€»ç»“](key_insights_latency_measurement.md) - äº†è§£æ ¸å¿ƒé—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
2. å†çœ‹ [é—®é¢˜æ€»ç»“](latency_measurement_issue_summary.md) - äº†è§£å…·ä½“çš„æ•°æ®å’Œä»£ç ä½ç½®

### æ·±å…¥ç†è§£
1. é˜…è¯» [å®Œæ•´é‡æ„æ–‡æ¡£](latency_measurement_refactoring.md) - äº†è§£å®Œæ•´çš„åˆ†æå’Œå®ç°
2. å‚è€ƒ [ä»£ç ä½ç½®è¯¦è§£](latency_measurement_code_locations.md) - äº†è§£å…·ä½“çš„ä»£ç å®ç°

### å®ç°ç»†èŠ‚
1. æŸ¥çœ‹ [Decode æµ‹é‡ç­–ç•¥](decode_measurement_strategy.md) - äº†è§£ä¸ºä»€ä¹ˆé€‰æ‹©åªæµ‹é‡æ€»æ—¶é—´
2. å‚è€ƒä»£ç å®ç°ï¼š`experiments/base_experiment.py::_measure_with_hooks()`

---

## ğŸ”— ç›¸å…³ä»£ç 

### æ ¸å¿ƒå®ç°
- `experiments/base_experiment.py` - æµ‹é‡æ–¹æ³•å®ç°
- `experiments/core_exp/acc_lat_profiling.py` - Profiling å®éªŒ
- `molmo/models/modeling_molmoe.py` - Model forward å®ç°

### å…³é”®æ–¹æ³•
- `BaseExperiment.measure_inference_latency()` - ä¸»æµ‹é‡æ–¹æ³•
- `BaseExperiment._measure_with_hooks()` - ä½¿ç”¨ hooks æµ‹é‡æ‰€æœ‰é˜¶æ®µ
- `BaseExperiment._measure_prefill_with_hooks()` - åªæµ‹é‡ prefill

---

## ğŸ“ æ›´æ–°å†å²

- **2025-12-31**: å®Œæˆ latency æµ‹é‡é‡æ„
  - ç§»é™¤ Vision Encoder å’Œ Projector çš„å•ç‹¬æµ‹é‡
  - å®ç° hooks åœ¨åŒä¸€ä¸ªæµç¨‹ä¸­æµ‹é‡æ‰€æœ‰é˜¶æ®µ
  - ä¼˜åŒ– Decode æµ‹é‡ï¼ˆåªæµ‹é‡æ€»æ—¶é—´ï¼‰

