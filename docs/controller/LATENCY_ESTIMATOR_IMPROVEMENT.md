# Latency Estimator æ”¹è¿›æ–¹æ¡ˆ

> **æ–‡æ¡£ç›®çš„**: åŸºäºæ•´ä½“è®¾è®¡ï¼Œæ·±åº¦åˆ†æå¹¶ç»™å‡ºLatency Estimatorçš„æ”¹è¿›æ–¹æ¡ˆ  
> **æœ€åæ›´æ–°**: 2026-01-08

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡å®šä½åˆ†æ](#è®¾è®¡å®šä½åˆ†æ)
2. [Decode Per-Token Latency ç›¸å…³æ€§åˆ†æ](#decode-per-token-latency-ç›¸å…³æ€§åˆ†æ)
3. [æ”¹è¿›æ–¹æ¡ˆ](#æ”¹è¿›æ–¹æ¡ˆ)
4. [å®æ–½å»ºè®®](#å®æ–½å»ºè®®)

---

## ğŸ¯ è®¾è®¡å®šä½åˆ†æ

### Latency Estimatoråœ¨æ•´ä½“è®¾è®¡ä¸­çš„è§’è‰²

**æ ¸å¿ƒä½œç”¨**:
1. **RLè®­ç»ƒåŠ é€Ÿ**: åœ¨GRPOè®­ç»ƒä¸­ï¼Œé¿å…å®é™…è¿è¡Œæ¨¡å‹ï¼ˆbatch_size=1é™åˆ¶ï¼‰ï¼Œä½¿ç”¨estimatorå¿«é€Ÿä¼°è®¡latency
2. **Budgetå¯è¡Œæ€§æ£€æŸ¥**: ç»™å®šlatency budgetï¼Œå¿«é€Ÿæ£€æŸ¥å“ªäº›configurationsæ˜¯å¯è¡Œçš„
3. **Configurationæœç´¢**: åœ¨è®­ç»ƒå‰ï¼Œå¿«é€Ÿè¯„ä¼°ä¸åŒconfigurationsçš„latencyç‰¹å¾

**å…³é”®çº¦æŸ**:
- **æ¨ç†æ—¶ä¸çŸ¥é“output_tokens**: è¿™æ˜¯latency estimatorè®¾è®¡çš„æ ¸å¿ƒå‰æ
- **Prefill latencyæ˜¯ç¡®å®šçš„**: ä¸€æ—¦é…ç½®ç¡®å®šï¼Œprefill latencyå°±ç¡®å®šäº†
- **Decode latencyæ˜¯ä¸ç¡®å®šçš„**: å› ä¸ºä¸çŸ¥é“ä¼šç”Ÿæˆå¤šå°‘ä¸ªtoken

### ç”¨æˆ·çš„è®¾è®¡æ€è·¯ï¼ˆæ­£ç¡®ï¼‰

> "ç”¨prefill latencyä½œä¸ºä¸»è¦çš„latencyæŒ‡æ ‡ï¼Œå› ä¸ºåœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬æ˜¯ä¸ç¡®å®šdecodeçš„é•¿åº¦çš„ï¼Œæ‰€ä»¥å³ä½¿çŸ¥é“äº†decode per-token latencyï¼Œä¹Ÿä¸çŸ¥é“total decode latencyã€‚æ‰€ä»¥decode per-token latencyåªèƒ½ä½œä¸ºæ¬¡è¦çš„latencyæŒ‡æ ‡ã€‚"

**è¿™ä¸ªæ€è·¯å®Œå…¨æ­£ç¡®ï¼**

**ç†ç”±**:
1. **Prefill latencyæ˜¯ç¡®å®šçš„**: ä¸€æ—¦é…ç½®ç¡®å®šï¼Œprefill latencyå°±ç¡®å®šäº†ï¼Œå¯ä»¥ç›´æ¥ç”¨äºbudgetæ£€æŸ¥
2. **Decode latencyæ˜¯ä¸ç¡®å®šçš„**: å³ä½¿çŸ¥é“per-token latencyï¼Œä¹Ÿä¸çŸ¥é“total decode latencyï¼ˆå› ä¸ºä¸çŸ¥é“output_tokensï¼‰
3. **å®é™…åº”ç”¨åœºæ™¯**: Controlleréœ€è¦æ ¹æ®latency budgeté€‰æ‹©configurationï¼Œä¸»è¦ä¾èµ–prefill latency

---

## ğŸ” Decode Per-Token Latency ç›¸å…³æ€§åˆ†æ

### ä¸ºä»€ä¹ˆDecode Per-Token Latencyä¼šè·ŸOutput_Tokensç›¸å…³ï¼Ÿ

**ç†è®ºé¢„æœŸ**: Decode per-token latencyåº”è¯¥åªè·Ÿæ¨¡å‹é…ç½®ï¼ˆtier, top_k, num_blocksï¼‰ç›¸å…³ï¼Œä¸åº”è¯¥è·Ÿoutput_tokensç›¸å…³ã€‚

**å®é™…è§‚å¯Ÿ**: æ•°æ®ä¸­æ˜¾ç¤ºdecode per-token latencyä¸output_tokensæœ‰0.70çš„ç›¸å…³æ€§ã€‚

### å¯èƒ½çš„åŸå› 

#### 1. **æµ‹é‡è¯¯å·®ï¼ˆæœ€å¯èƒ½ï¼‰**

ä»åˆ†æç»“æœçœ‹ï¼š
- **çŸ­è¾“å‡ºï¼ˆ<=3 tokensï¼‰**: æµ‹é‡è¯¯å·®6.09%ï¼ˆç›¸å¯¹è¯¯å·®ï¼‰
- **é•¿è¾“å‡ºï¼ˆ>=10 tokensï¼‰**: æµ‹é‡è¯¯å·®2.00%ï¼ˆç›¸å¯¹è¯¯å·®ï¼‰

**åŸå› **:
- Decode latencyé€šè¿‡å‡æ³•è®¡ç®—ï¼š`T_LLM_decode = T_total - T_vision_total - T_LLM_prefill`
- æ¯ä¸ªç»„ä»¶çš„æµ‹é‡è¯¯å·®ä¼šç´¯ç§¯
- å¯¹äºçŸ­è¾“å‡ºï¼Œ`T_LLM_decode`å¾ˆå°ï¼ˆå¦‚20-40msï¼‰ï¼Œæµ‹é‡è¯¯å·®å æ¯”è¾ƒå¤§
- å¯¹äºé•¿è¾“å‡ºï¼Œ`T_LLM_decode`è¾ƒå¤§ï¼ˆå¦‚200-400msï¼‰ï¼Œæµ‹é‡è¯¯å·®å æ¯”å°

**ç¤ºä¾‹**:
```
çŸ­è¾“å‡ºï¼ˆ2 tokensï¼‰:
  T_total = 150ms
  T_vision + T_prefill = 140ms
  T_LLM_decode = 10ms (æµ‹é‡è¯¯å·®å¯èƒ½Â±2msï¼Œå 20%)
  T_decode_per_token = 10ms / 2 = 5ms/token (è¯¯å·®æ”¾å¤§)

é•¿è¾“å‡ºï¼ˆ20 tokensï¼‰:
  T_total = 500ms
  T_vision + T_prefill = 140ms
  T_LLM_decode = 360ms (æµ‹é‡è¯¯å·®å¯èƒ½Â±2msï¼Œå 0.5%)
  T_decode_per_token = 360ms / 20 = 18ms/token (è¯¯å·®è¾ƒå°)
```

#### 2. **KV Cacheå¢é•¿ï¼ˆé‡è¦å‘ç°ï¼‰**

**æ›´æ–°**: é€šè¿‡output tokensåˆ†å¸ƒåˆ†æï¼Œæˆ‘ä»¬å‘ç°KV cacheå¢é•¿çš„å½±å“æ¯”é¢„æœŸæ›´å¤§ã€‚

**è§‚å¯Ÿåˆ°çš„ç°è±¡**:
- 2 tokens: ~24.6 ms/token
- 3-5 tokens: ~34.4 ms/token  
- 6-10 tokens: ~41.1 ms/token
- 21+ tokens: ~45.2 ms/token

**å¢é•¿å¹…åº¦**: ä»2 tokensåˆ°21+ tokensï¼Œdecode per-token latencyå¢åŠ äº†çº¦**83%**ã€‚

**åŸå› åˆ†æ**:
1. **å†…å­˜è®¿é—®æ—¶é—´å¢åŠ **: KV cacheå¤§å°éšåºåˆ—é•¿åº¦çº¿æ€§å¢é•¿ï¼Œæ¯ä¸ªdecode stepéœ€è¦è¯»å–æ›´å¤škey-valueå¯¹
2. **å†…å­˜å¸¦å®½ç“¶é¢ˆ**: æ›´é•¿çš„åºåˆ—éœ€è¦æ›´å¤šå†…å­˜å¸¦å®½ï¼Œå¯èƒ½è¾¾åˆ°GPUå¸¦å®½ä¸Šé™
3. **ç¼“å­˜æ•ˆç‡ä¸‹é™**: é•¿åºåˆ—å¯èƒ½è¶…å‡ºGPUç¼“å­˜å®¹é‡ï¼Œå¯¼è‡´ç¼“å­˜æœªå‘½ä¸­å¢åŠ 
4. **æ³¨æ„åŠ›è®¡ç®—å¼€é”€**: è™½ç„¶æ¯ä¸ªtokençš„è®¡ç®—å¤æ‚åº¦ç›¸åŒï¼Œä½†å†…å­˜è®¿é—®æ¨¡å¼å˜åŒ–

**æ•°å­¦æ¨¡å‹**:
```
T_decode_per_token(L) = T_base + T_kv_cache(L)
```

å…¶ä¸­`T_kv_cache(L)`éšåºåˆ—é•¿åº¦Lå¢é•¿ï¼Œè¡¨ç°ä¸ºï¼š
- **æ—©æœŸï¼ˆ2-10 tokensï¼‰**: è¿‘ä¼¼çº¿æ€§å¢é•¿ï¼ˆå†…å­˜å¸¦å®½é™åˆ¶ï¼‰
- **åæœŸï¼ˆ10+ tokensï¼‰**: å¢é•¿æ”¾ç¼“ï¼ˆç¼“å­˜æ•ˆåº”ç¨³å®šæˆ–å…¶ä»–ç“¶é¢ˆä¸»å¯¼ï¼‰

**è¯¦ç»†åˆ†æ**: å‚è§ `docs/analysis/DECODE_LATENCY_VS_OUTPUT_TOKENS.md`

#### 3. **ç¡¬ä»¶çŠ¶æ€æ³¢åŠ¨**

- GPUæ¸©åº¦ã€é¢‘ç‡æ³¢åŠ¨
- å†…å­˜å¸¦å®½ç«äº‰
- ç³»ç»Ÿè´Ÿè½½

ä½†è¿™äº›å› ç´ åº”è¯¥å¯¹æ‰€æœ‰è¾“å‡ºé•¿åº¦éƒ½æœ‰å½±å“ï¼Œä¸åº”è¯¥å¯¼è‡´ä¸output_tokensçš„ç›¸å…³æ€§ã€‚

### ç»“è®º

**ä¸»è¦åŸå› **: **KV cacheå¢é•¿**å’Œ**æµ‹é‡è¯¯å·®**å…±åŒä½œç”¨ã€‚

**è¯æ®**:
1. **KV cacheå¢é•¿çš„å½±å“**:
   - Decode per-token latencyéšoutput tokensæ•°é‡æ˜¾è‘—å¢åŠ ï¼ˆ83%å¢é•¿ï¼‰
   - ç¬¦åˆKV cacheå¤§å°çº¿æ€§å¢é•¿çš„ç†è®ºé¢„æœŸ
   - å†…å­˜å¸¦å®½å’Œç¼“å­˜æ•ˆç‡æ˜¯ä¸»è¦ç“¶é¢ˆ

2. **æµ‹é‡è¯¯å·®çš„æ”¾å¤§**:
   - çŸ­è¾“å‡ºçš„æµ‹é‡è¯¯å·®ï¼ˆ6.09%ï¼‰æ˜æ˜¾å¤§äºé•¿è¾“å‡ºï¼ˆ2.00%ï¼‰
   - å¯¹äº1ä¸ªtokençš„æ ·æœ¬ï¼Œdecode latencyæµ‹é‡ä¸º0.00 msï¼ˆæ˜æ˜¾é”™è¯¯ï¼‰
   - æµ‹é‡è¯¯å·®åœ¨çŸ­è¾“å‡ºä¸­è¢«æ”¾å¤§

**ç»¼åˆå½±å“**: 
- KV cacheå¢é•¿æ˜¯**ç³»ç»Ÿæ€§å› ç´ **ï¼Œå¯¼è‡´decode per-token latencyéšåºåˆ—é•¿åº¦å¢åŠ 
- æµ‹é‡è¯¯å·®æ˜¯**éšæœºå› ç´ **ï¼Œåœ¨çŸ­è¾“å‡ºä¸­å½±å“æ›´å¤§
- ä¸¤è€…å…±åŒä½œç”¨ï¼Œå¯¼è‡´decode per-token latencyä¸output_tokensçš„å¼ºç›¸å…³æ€§ï¼ˆ0.70ï¼‰

---

## ğŸ’¡ æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: é‡æ–°å®šä½Latency Estimatorï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€æƒ³**: 
- **Prefill latencyæ˜¯ä¸»è¦æŒ‡æ ‡**ï¼šç”¨äºbudgetæ£€æŸ¥å’Œconfigurationé€‰æ‹©
- **Decode per-token latencyæ˜¯æ¬¡è¦æŒ‡æ ‡**ï¼šä»…ä½œä¸ºå‚è€ƒï¼Œä¸ç”¨äºç›´æ¥è®¡ç®—total latency

**è®¾è®¡è°ƒæ•´**:

1. **è®­ç»ƒç›®æ ‡è°ƒæ•´**:
   - **ä¸»è¦ç›®æ ‡**: Prefill latencyï¼ˆé«˜ç²¾åº¦è¦æ±‚ï¼ŒRÂ² > 0.9ï¼‰
   - **æ¬¡è¦ç›®æ ‡**: Decode per-token latencyï¼ˆä¸­ç­‰ç²¾åº¦è¦æ±‚ï¼ŒRÂ² > 0.5å³å¯ï¼‰

2. **æŸå¤±å‡½æ•°è°ƒæ•´**:
   ```python
   # å½“å‰ï¼šç­‰æƒé‡
   loss = loss_prefill + loss_decode
   
   # æ”¹è¿›ï¼šåŠ æƒï¼Œprefillæƒé‡æ›´å¤§
   loss = 2.0 * loss_prefill + 1.0 * loss_decode
   ```

3. **ä½¿ç”¨æ–¹å¼è°ƒæ•´**:
   ```python
   # å½“å‰ï¼šå°è¯•è®¡ç®—total latency
   T_total = T_prefill + T_decode_per_token * expected_output_tokens
   
   # æ”¹è¿›ï¼šä¸»è¦ä½¿ç”¨prefillï¼Œdecodeä»…ä½œå‚è€ƒ
   # Budgetæ£€æŸ¥ï¼šä¸»è¦çœ‹prefill
   if T_prefill <= latency_budget * 0.8:  # ç•™20%ç»™decode
       # Configurationå¯è¡Œ
       pass
   
   # Decode per-tokenä»…ä½œå‚è€ƒï¼ˆç”¨äºä¼°ç®—æœ€å¤§å¯èƒ½çš„output_tokensï¼‰
   max_possible_tokens = (latency_budget - T_prefill) / T_decode_per_token
   ```

### æ–¹æ¡ˆ2: æ”¹è¿›Decode Latencyé¢„æµ‹

**æ€è·¯**: æ—¢ç„¶decode per-token latencyä¸output_tokensç›¸å…³ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **ä½¿ç”¨é…ç½®ç›¸å…³çš„ç»éªŒå€¼**:
   - ä¸é¢„æµ‹decode per-token latency
   - ä½¿ç”¨é…ç½®ç›¸å…³çš„ç»éªŒå€¼ï¼ˆä»æ•°æ®ä¸­ç»Ÿè®¡ï¼‰
   - ä¾‹å¦‚ï¼š`decode_per_token = f(tier, top_k, num_blocks)`ï¼ˆå›ºå®šå€¼ï¼‰

2. **é¢„æµ‹åˆ†ä½æ•°è€Œéå‡å€¼**:
   - é¢„æµ‹P50, P95åˆ†ä½æ•°
   - ä½¿ç”¨P95è¿›è¡Œä¿å®ˆä¼°è®¡

3. **æ¥å—å½“å‰æ€§èƒ½**:
   - 20.88%çš„ç›¸å¯¹è¯¯å·®åœ¨å¯æ¥å—èŒƒå›´å†…
   - åœ¨budgetæ£€æŸ¥æ—¶å¢åŠ safety margin

### æ–¹æ¡ˆ3: æ•°æ®æ¸…æ´—å’Œæ¨¡å‹æ”¹è¿›

**æ•°æ®æ¸…æ´—**:
1. **æ›´ä¸¥æ ¼çš„å¼‚å¸¸å€¼è¿‡æ»¤**: ä½¿ç”¨IQRæ–¹æ³•ï¼Œè¿‡æ»¤æ‰æ˜æ˜¾å¼‚å¸¸çš„æ ·æœ¬
2. **æŒ‰é…ç½®åˆ†ç»„è®­ç»ƒ**: ä¸ºä¸åŒé…ç½®è®­ç»ƒä¸åŒçš„æ¨¡å‹ï¼ˆå¦‚æœæ•°æ®è¶³å¤Ÿï¼‰

**æ¨¡å‹æ”¹è¿›**:
1. **åˆ†ç¦»æ¨¡å‹**: Prefillå’ŒDecodeä½¿ç”¨ä¸åŒçš„æ¨¡å‹
2. **æ›´å¤æ‚çš„Decodeæ¨¡å‹**: ä¸ºDecodeä½¿ç”¨æ›´æ·±çš„ç½‘ç»œï¼ˆä½†éœ€è¦æ›´å¤šæ•°æ®ï¼‰

---

## âœ… æ¨èå®æ–½æ–¹æ¡ˆ

### çŸ­æœŸæ”¹è¿›ï¼ˆç«‹å³å®æ–½ï¼‰

1. **è°ƒæ•´è®­ç»ƒç›®æ ‡æƒé‡**:
   ```python
   # åœ¨LatencyEstimatorTrainerä¸­
   loss = 2.0 * loss_prefill + 1.0 * loss_decode  # Prefillæƒé‡æ›´å¤§
   ```

2. **æ˜ç¡®ä½¿ç”¨æ–¹å¼**:
   - Prefill latencyç”¨äºä¸»è¦budgetæ£€æŸ¥
   - Decode per-token latencyä»…ä½œå‚è€ƒ
   - åœ¨budgetæ£€æŸ¥æ—¶ï¼Œä½¿ç”¨ä¿å®ˆä¼°è®¡ï¼ˆprefill + decode_per_token * expected_max_tokensï¼‰

3. **æ›´æ–°æ–‡æ¡£**:
   - æ˜ç¡®è¯´æ˜prefillæ˜¯ä¸»è¦æŒ‡æ ‡ï¼Œdecodeæ˜¯æ¬¡è¦æŒ‡æ ‡
   - è¯´æ˜decode per-token latencyçš„å±€é™æ€§

### ä¸­æœŸæ”¹è¿›ï¼ˆå¦‚æœéœ€è¦ï¼‰

1. **æ•°æ®æ¸…æ´—**: æ›´ä¸¥æ ¼çš„å¼‚å¸¸å€¼è¿‡æ»¤
2. **åˆ†ç¦»æ¨¡å‹**: ä¸ºdecodeä½¿ç”¨å•ç‹¬çš„ã€æ›´ç®€å•çš„æ¨¡å‹ï¼ˆç”šè‡³å¯ä»¥æ˜¯æŸ¥æ‰¾è¡¨ï¼‰
3. **åˆ†ä½æ•°å›å½’**: é¢„æµ‹P95åˆ†ä½æ•°ï¼Œæä¾›ä¸ç¡®å®šæ€§ä¼°è®¡

### é•¿æœŸæ”¹è¿›ï¼ˆå¦‚æœé—®é¢˜ä¸¥é‡ï¼‰

1. **é‡æ–°è®¾è®¡**: è€ƒè™‘æ˜¯å¦åªé¢„æµ‹prefillï¼Œdecodeä½¿ç”¨ç»éªŒå€¼
2. **åœ¨çº¿æ ¡å‡†**: åœ¨æ¨ç†æ—¶è¿›è¡Œåœ¨çº¿æ ¡å‡†

---

## ğŸ“Š å…³äºDecode Per-Token Latencyçš„ç»“è®º

### ä¸ºä»€ä¹ˆä¸Output_Tokensç›¸å…³ï¼Ÿ

**ä¸»è¦åŸå› **: **æµ‹é‡è¯¯å·®è¢«æ”¾å¤§**

- Decode latencyé€šè¿‡å‡æ³•è®¡ç®—ï¼Œæµ‹é‡è¯¯å·®ä¼šç´¯ç§¯
- å¯¹äºçŸ­è¾“å‡ºï¼Œæµ‹é‡è¯¯å·®å æ¯”è¾ƒå¤§ï¼ˆ6.09%ï¼‰
- å¯¹äºé•¿è¾“å‡ºï¼Œæµ‹é‡è¯¯å·®å æ¯”è¾ƒå°ï¼ˆ2.00%ï¼‰
- è¿™å¯¼è‡´çŸ­è¾“å‡ºçš„decode per-token latencyè¢«ä½ä¼°ï¼Œé•¿è¾“å‡ºçš„è¢«é«˜ä¼°

**æ¬¡è¦åŸå› **:
- KV cacheå¢é•¿ï¼ˆå½±å“è¾ƒå°ï¼‰
- ç¡¬ä»¶çŠ¶æ€æ³¢åŠ¨ï¼ˆå½±å“è¾ƒå°ï¼‰

### å¯¹è®¾è®¡çš„å½±å“

1. **ä¸å½±å“ä¸»è¦è®¾è®¡**: Prefill latencyé¢„æµ‹å‡†ç¡®ï¼ˆRÂ²=0.93ï¼‰ï¼Œå¯ä»¥æ»¡è¶³ä¸»è¦éœ€æ±‚
2. **Decodeä½œä¸ºå‚è€ƒ**: Decode per-token latencyè™½ç„¶RÂ²è¾ƒä½ï¼Œä½†ç›¸å¯¹è¯¯å·®20.88%ä»å¯æ¥å—ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒ
3. **ä½¿ç”¨ä¿å®ˆä¼°è®¡**: åœ¨budgetæ£€æŸ¥æ—¶ï¼Œä½¿ç”¨ä¿å®ˆä¼°è®¡ï¼ˆå¢åŠ safety marginï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[LATENCY_ESTIMATOR_DESIGN.md](LATENCY_ESTIMATOR_DESIGN.md)**: Latency Estimatorè®¾è®¡æ–‡æ¡£
- **[DECODE_LATENCY_ANALYSIS.md](DECODE_LATENCY_ANALYSIS.md)**: Decode Latencyåˆ†æ
- **[DESIGN.md](DESIGN.md)**: Controlleræ•´ä½“è®¾è®¡

---

**æœ€åæ›´æ–°**: 2026-01-08  
**ç»´æŠ¤è€…**: Controller Team

