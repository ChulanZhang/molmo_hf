# Exp3 Block Pruning Recommendations

## 概述

本文档提供了基于跨数据集 beam search 实验的 block 剪枝建议。根据要移除的 block 数量，提供了两种策略：
1. **独立最优策略**：每个数量级别的最佳组合（不考虑累积）
2. **逐步剪枝策略**：基于前一步结果逐步添加要移除的 blocks（贪心方法）

## 独立最优策略

### 移除 1 个 Block

**最佳选择：移除 Block 4**

- **平均准确率下降**: 3.09% ± 3.15%
- **测试数据集数**: 8 个（所有数据集）
- **平均准确率**: 72.61%
- **数据集**: okvqa, coco-2014-vqa, st-qa, science-qa-img, tally-qa, doc-qa, text-vqa, coco-caption

**Top 5 选择**：
1. Block 4: 3.09% ± 3.15% (8 datasets)
2. Block 3: 3.69% ± 3.53% (8 datasets)
3. Block 6: 3.95% ± 2.18% (8 datasets)
4. Block 11: 4.14% ± 3.99% (8 datasets)
5. Block 7: 5.06% ± 5.01% (8 datasets)

### 移除 2 个 Blocks

**最佳选择：移除 Blocks [2, 10]**

- **平均准确率下降**: 2.42% ± 3.17%
- **测试数据集数**: 2 个
- **平均准确率**: 50.42%
- **数据集**: coco-2014-vqa, coco-caption

**Top 5 选择**：
1. [2, 10]: 2.42% ± 3.17% (2 datasets)
2. [2, 12]: 3.04% ± 4.05% (3 datasets)
3. [12, 14]: 3.32% ± 0.98% (2 datasets)
4. [2, 14]: 3.56% ± 3.31% (3 datasets)
5. [2, 15]: 4.27% ± 4.97% (2 datasets)

**注意**：虽然 [2, 10] 的平均下降最小，但只在 2 个数据集上测试。如果需要更稳健的选择，可以考虑 [2, 12]（3 个数据集，下降 3.04%）。

### 移除 3 个 Blocks

**最佳选择：移除 Blocks [12, 13, 14]**

- **平均准确率下降**: 6.84% ± 2.15%
- **测试数据集数**: 2 个
- **平均准确率**: 76.76%
- **数据集**: science-qa-img, tally-qa

**Top 5 选择**：
1. [12, 13, 14]: 6.84% ± 2.15% (2 datasets)
2. [11, 13, 14]: 7.42% ± 5.47% (2 datasets)
3. [2, 4, 7]: 7.47% ± 6.47% (3 datasets)
4. [4, 10, 13]: 7.53% ± 8.73% (2 datasets)
5. [4, 11, 13]: 7.81% ± 6.79% (3 datasets)

**注意**：如果需要更稳健的选择，可以考虑 [2, 4, 7]（3 个数据集，下降 7.47%）。

### 移除 4 个 Blocks

**最佳选择：移除 Blocks [2, 4, 13, 14]**

- **平均准确率下降**: 5.05% ± 2.37%
- **测试数据集数**: 2 个
- **平均准确率**: 45.19%
- **数据集**: tally-qa, coco-caption

**Top 5 选择**：
1. [2, 4, 13, 14]: 5.05% ± 2.37% (2 datasets)
2. [2, 4, 7, 12]: 6.62% ± 6.65% (2 datasets)
3. [3, 4, 7, 13]: 9.73% ± 11.36% (2 datasets)
4. [3, 4, 13, 14]: 13.14% ± 11.76% (3 datasets)
5. [6, 11, 13, 14]: 15.86% ± 3.75% (2 datasets)

**注意**：如果需要更稳健的选择，可以考虑 [3, 4, 13, 14]（3 个数据集，下降 13.14%）。

## 逐步剪枝策略（推荐）

这种方法基于贪心策略，每一步都基于前一步的结果选择下一个要移除的 block。

### Step 1: 移除 1 个 Block

**选择：移除 Block 4**

- **平均准确率下降**: 3.09% ± 3.15%
- **测试数据集数**: 8 个（所有数据集）
- **累积准确率下降**: 3.09%

### Step 2: 移除 2 个 Blocks

**选择：移除 Blocks [4, 13]**

- **平均准确率下降**: 5.41% ± 4.43%
- **测试数据集数**: 7 个
- **累积准确率下降**: 5.41%
- **增量下降**（从 Step 1）: 2.32%

### Step 3: 移除 3 个 Blocks

**选择：移除 Blocks [4, 10, 13]**

- **平均准确率下降**: 7.53% ± 8.73%
- **测试数据集数**: 2 个
- **累积准确率下降**: 7.53%
- **增量下降**（从 Step 2）: 2.12%

### Step 4: 移除 4 个 Blocks

**选择：移除 Blocks [2, 4, 10, 13]**

- **平均准确率下降**: 18.36% ± 18.90%
- **测试数据集数**: 2 个
- **累积准确率下降**: 18.36%
- **增量下降**（从 Step 3）: 10.83%

**注意**：Step 4 的增量下降较大（10.83%），说明移除第 4 个 block（Block 2）的影响较大。

## 建议

### 保守策略（推荐用于生产环境）

1. **只移除 Block 4**：准确率下降仅 3.09%，在所有 8 个数据集上验证，结果最稳健。
2. **移除 Blocks [4, 13]**：准确率下降 5.41%，在 7 个数据集上验证，增量下降仅 2.32%。

### 激进策略（追求更高压缩率）

1. **移除 Blocks [2, 4, 13, 14]**：准确率下降 5.05%，但只在 2 个数据集上测试。
2. **移除 Blocks [2, 4, 7, 12]**：准确率下降 6.62%，在 2 个数据集上测试。

### 平衡策略

1. **移除 Blocks [2, 4, 7]**：准确率下降 7.47%，在 3 个数据集上测试，是移除 3 个 blocks 中测试最充分的。

## 关键发现

1. **Block 4 是最不重要的单个 block**：在所有 8 个数据集上测试，平均下降仅 3.09%，标准差也较小（3.15%），说明结果稳定。

2. **Block 0 至关重要**：移除 Block 0 会导致平均准确率下降 62.7%，绝对不能移除。

3. **中间层 blocks (3, 4, 6, 11) 相对不重要**：这些 blocks 的移除对准确率影响较小，适合作为剪枝候选。

4. **组合移除可能比单 block 移除更好**：例如 [2, 10] 的平均下降（2.42%）比单独移除 Block 4（3.09%）还要小，但测试数据集较少。

5. **逐步移除的增量影响递增**：从 Step 1 到 Step 4，每一步的增量影响逐渐增大，说明 blocks 之间存在依赖关系。

## 文件位置

- **推荐结果**: `results/profiling/exp3_beam_search_multi_dataset/analysis/pruning_recommendations.json`
- **完整分析**: `results/profiling/exp3_beam_search_multi_dataset/analysis/cross_dataset_analysis.json`

## 使用方法

```bash
# 生成推荐
python3 experiments/profiling/knob3_layers/find_best_by_num_removed.py

# 查看推荐结果
cat results/profiling/exp3_beam_search_multi_dataset/analysis/pruning_recommendations.json | jq
```


